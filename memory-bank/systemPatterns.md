# 系统模式

## 架构概述
Virtual Avatar 采用前后端分离的微服务架构，前端负责 3D 渲染和用户交互，后端负责音频处理和 AI 集成。系统通过 WebSocket 进行实时通信，确保低延迟的语音对话体验。

## 系统架构图
```
┌─────────────────┐    WebSocket    ┌─────────────────┐
│   前端 (Web)    │◄───────────────►│   后端 (Node)   │
│                 │  音频流 + 控制   │                 │
│  Vue 3 + Three  │                 │  WebSocket服务  │
│  3D渲染 + UI    │◄───────────────►│  AI处理管道     │
└─────────────────┘                 └────────┬────────┘
                                             │
                                             ▼
                                    ┌─────────────────┐
                                    │  外部AI服务     │
                                    │  SiliconFlow    │
                                    │  (STT+LLM+TTS)  │
                                    └─────────────────┘
```

## 核心组件模式

### 1. 3D 游戏引擎模式
**模式名称**：组件化游戏对象系统
**实现位置**：`web/src/components/3D/`
**设计思想**：将 3D 对象抽象为 GameObject，通过 Component 系统添加功能

```typescript
// 核心类结构
GameManager (主控制器)
├── ModelManager (模型加载)
├── TextureManager (纹理管理)
├── SceneManager (场景管理)
├── CameraManager (相机控制)
├── GameObjectManager (游戏对象管理)
└── RaycasterManager (射线检测)
```

**关键特性**：
- **组件化设计**：每个功能作为独立组件添加到 GameObject
- **管理器模式**：集中管理同类资源
- **事件驱动**：通过 EventBus 进行组件间通信

### 2. 音频处理管道
**模式名称**：管道过滤器模式
**实现位置**：`server/src/app.ts`
**处理流程**：
```
用户语音 → WebSocket传输 → WebM转MP3 → 语音识别(STT) → LLM处理 → 语音合成(TTS) → 返回音频
```

**关键特性**：
- **异步处理**：每个步骤异步执行，避免阻塞
- **错误隔离**：单个步骤失败不影响整体流程
- **临时文件管理**：使用系统临时目录处理音频文件

### 3. WebSocket 通信模式
**模式名称**：会话管理 + 心跳检测
**实现位置**：`server/src/clientManager.ts`
**设计思想**：为每个连接创建独立会话，管理连接状态和资源

```typescript
ClientManager
├── createClient()    // 创建客户端会话
├── removeClient()    // 移除客户端
├── getClient()       // 获取客户端
└── cleanup()         // 清理资源
```

**关键特性**：
- **会话隔离**：每个客户端独立处理
- **资源管理**：自动清理过期会话
- **状态跟踪**：记录最后活动时间

### 4. 资源加载模式
**模式名称**：集中式资源管理器
**实现位置**：`web/src/components/3D/ModelManager.ts`、`TextureManager.ts`
**设计思想**：统一管理 3D 资源和纹理，提供缓存和复用

```typescript
// 资源加载流程
1. 注册资源路径
2. 批量加载资源
3. 缓存加载结果
4. 提供资源访问接口
```

## 数据流模式

### 前端数据流
```
用户交互 → EventBus → 组件响应 → 状态更新 → 3D渲染
```

### 后端数据流
```
WebSocket消息 → 音频处理 → AI API调用 → 结果返回 → WebSocket发送
```

### 跨组件通信
- **EventBus 模式**：`web/src/utils/EventBus.ts`
- **全局状态**：`web/src/utils/Globals.ts`
- **组件引用**：Vue 的 ref 和 provide/inject

## 设计决策

### 1. 为什么选择 Three.js？
- **成熟度**：最流行的 Web 3D 库，社区活跃
- **性能**：WebGL 封装良好，性能优化充分
- **兼容性**：支持现代浏览器，移动端友好
- **扩展性**：丰富的插件和工具生态

### 2. 为什么选择 WebSocket？
- **实时性**：双向实时通信，适合音频流
- **低延迟**：相比 HTTP 轮询，延迟更低
- **二进制支持**：原生支持二进制数据传输
- **连接管理**：支持持久连接和状态管理

### 3. 为什么选择 SiliconFlow API？
- **一体化**：提供 STT、LLM、TTS 完整链条
- **中文优化**：对中文语音和语言有良好支持
- **成本效益**：相比自建模型成本更低
- **易用性**：API 设计简洁，文档完善

### 4. 为什么采用组件化架构？
- **可维护性**：功能模块化，易于理解和修改
- **可测试性**：组件独立，便于单元测试
- **可扩展性**：新功能通过添加组件实现
- **复用性**：组件可在不同项目中复用

## 关键实现路径

### 1. 3D 场景初始化路径
```
ThreeView.vue → GameManager.init() → 资源加载 → 场景构建 → 渲染循环
```

### 2. 音频处理路径
```
前端录音 → WebSocket.send() → server/app.ts → AI处理管道 → 返回音频 → 前端播放
```

### 3. 用户交互路径
```
鼠标/触摸 → Raycaster检测 → 事件触发 → UI反馈 → 状态更新
```

## 性能考虑

### 1. 3D 性能优化
- **资源懒加载**：按需加载模型和纹理
- **渲染优化**：使用合适的材质和几何体
- **帧率控制**：requestAnimationFrame 循环
- **内存管理**：及时释放不再使用的资源

### 2. 网络性能优化
- **音频压缩**：WebM 格式，适合语音
- **连接复用**：WebSocket 持久连接
- **批量处理**：AI API 调用优化
- **缓存策略**：重复资源缓存

### 3. 内存管理
- **资源缓存**：已加载资源复用
- **临时清理**：及时清理临时文件
- **连接清理**：断开连接的资源回收
- **垃圾回收**：JavaScript 自动 GC

## 扩展模式

### 1. 插件系统（规划中）
```typescript
interface Plugin {
  name: string;
  init(game: GameManager): void;
  update?(deltaTime: number): void;
  destroy?(): void;
}
```

### 2. 配置驱动（现有）
```typescript
// textureConfig.ts - 纹理配置
// ApIConfig.json - API 配置
// compose.yaml - 部署配置
```

### 3. 事件系统（现有）
```typescript
// EventBus.ts - 全局事件总线
// 支持：on(), off(), emit()
```

## 系统约束

### 技术约束
- **浏览器支持**：需要 WebGL 和 WebAudio API
- **网络要求**：稳定的网络连接，低延迟
- **API 限制**：SiliconFlow API 调用频率和配额
- **设备性能**：需要一定的 GPU 和 CPU 性能

### 业务约束
- **成本控制**：AI API 调用成本需要监控
- **隐私考虑**：语音数据需要安全处理
- **合规要求**：符合数据保护法规
- **用户体验**：需要平衡质量和性能

## 故障处理模式

### 1. 连接故障
- **重连机制**：前端自动重连 WebSocket
- **超时处理**：设置合理的超时时间
- **优雅降级**：连接失败时提供友好提示

### 2. 资源加载失败
- **重试机制**：重要资源自动重试
- **占位符**：加载失败时显示占位符
- **错误报告**：记录加载错误信息

### 3. AI 服务故障
- **备用方案**：使用本地简单回复
- **错误缓存**：避免重复失败请求
- **状态同步**：及时更新用户界面状态